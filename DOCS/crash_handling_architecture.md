# CFP 崩溃处理架构设计文档

## 1. 概述

CFP（CAPON Frontend Processor）系统采用工业级崩溃处理架构，将崩溃处理分为客户端和服务器端两个部分：

- **客户端**: 负责崩溃捕获、Minidump生成和最小信息上报
- **服务器端**: 负责DUMP文件的详细解析和分析

这种设计确保了在崩溃发生时，客户端能够安全、快速地记录崩溃现场，而详细的分析工作则由服务器在安全环境中完成。

## 2. 客户端崩溃处理

### 2.1 崩溃捕获机制

客户端实现了Windows结构化异常处理（SEH）来捕获各种类型的崩溃：

- 访问违规（EXCEPTION_ACCESS_VIOLATION）
- 除零错误（EXCEPTION_INT_DIVIDE_BY_ZERO）
- 栈溢出（EXCEPTION_STACK_OVERFLOW）
- 以及其他所有类型的异常

### 2.2 安全崩溃处理原则

在崩溃处理过程中，遵循以下安全原则：

- **避免使用不可信的CRT/STL**
- **不使用可能引发二次崩溃的库（如spdlog、fmt、iostream）**
- **使用最小安全路径进行崩溃信息上报**
- **在异常处理完成后立即退出进程**

### 2.3 Minidump生成

客户端在捕获到崩溃后，会生成一个包含以下信息的Minidump文件：

- 崩溃时的寄存器状态
- 内存快照
- 线程信息
- 模块信息
- 调用栈信息

### 2.4 最小信息上报

通过UDP协议发送最小崩溃信息到服务器，包含：

- 进程ID（pid）
- 线程ID（tid）
- 异常代码（ExceptionCode）
- 崩溃地址（崩溃位置）
- 时间戳
- Build ID/Git Hash

## 3. 服务器端崩溃分析

### 3.1 为什么在服务器端进行解析

工业级的DUMP解析必须在服务器侧完成，原因如下：

1. **崩溃现场不是安全环境**：
   - 堆可能已损坏
   - 加载器锁可能被占用
   - CRT/STL可能不可信
   - 标准库函数可能引发二次崩溃

2. **PDB管理问题**：
   - PDB文件体积巨大
   - 随程序分发PDB会泄露源码结构
   - 不同版本的符号管理复杂

3. **崩溃分析是离线行为**：
   - 客户端崩溃后生成dump文件
   - 客户端进程安全退出
   - 服务器端在安全环境中进行详细分析

### 3.2 服务器端标准流程

1. **客户端上传**

   ```
   crash_20260105_170543.dmp
   build-id.txt
   ```

2. **服务器符号管理**

   ```
   symbols/
     crash_example.exe/
       A1B2C3D4/  # GUID + Age
         crash_example.pdb
   ```

3. **使用cdb/WinDbg解析（无UI模式）**

   ```cmd
   cdb -z crash_20260105_170543.dmp ^
       -y srv*D:\symbols ^
       -c "!analyze -v; kv; q"
   ```

4. **解析结果入库**
   - 顶级调用帧
   - 崩溃函数
   - 源文件和行号
   - 调用栈哈希值

## 4. 系统架构

```
┌──────────────┐
│ crash_example│
│              │
│ SEH handler  │
│  ├─ MiniDump │────┐
│  ├─ CRASH UDP│    │
│  └─ exit     │    │
└──────────────┘    │
                     ▼
              ┌──────────────┐
              │ Crash Server │
              │              │
              │ dump store   │
              │ pdb store    │
              │ sym server   │
              │ windbg/cdb   │
              └──────────────┘
```

## 5. 开发阶段 vs 生产阶段

### 5.1 开发阶段模式（当前阶段）

在开发和调试阶段，客户端会：

- 捕获异常
- 生成Minidump
- 解析详细堆栈信息（用于本地调试）
- 通过UDP发送最小崩溃信息

### 5.2 生产阶段模式（未来规划）

在生产环境中，客户端将：

- 捕获异常
- 生成Minidump
- 立即退出进程（不进行详细解析）
- 上传Minidump文件到服务器

## 6. 实现阶段规划

### 阶段1（已完成）

- ✅ SEH + Minidump生成
- ✅ 本地WinDbg可解析
- ✅ PDB匹配检查
- ✅ 最小UDP崩溃上报

### 阶段2（下一步）

- ✅ DUMP文件自动上传
- ✅ Build ID写入DUMP文件
- ✅ 服务器保存DUMP文件
- ✅ （暂不解析）

### 阶段3（平台化）

- ✅ 符号服务器
- ✅ CDB自动化解析
- ✅ 崩溃去重
- ✅ Top崩溃排名

## 7. 关键原则

- **客户端职责**：忠实记录崩溃现场
- **服务器职责**：冷静分析崩溃原因
- **安全第一**：在崩溃处理中避免二次崩溃
- **分离关注点**：崩溃捕获与崩溃分析分离

## 8. 未来发展方向

1. **崩溃上传协议**：设计HTTP/UDP/file drop上传协议
2. **Windows崩溃解析服务器脚本**：自动化崩溃分析
3. **双模式设计**：开发模式和生产模式的CrashHandlerImpl
4. **工业标准**：对标Crashpad/Breakpad等工业级解决方案
