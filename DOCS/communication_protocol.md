# DvpDetect 通信协议详细设计文档

## 文档概述

本文档详细描述了 DvpDetect 系统中各个组件之间的通信协议，包括 TCP 通信协议和 Redis PUB/SUB 通信协议。

## 当前架构 - 单机单相机模式

在当前部署中，系统采用单机单相机模式，即一台电脑控制一个相机。这种模式具有良好的稳定性和实时性，满足大多数现场部署需求。

### TCP 通信协议

#### 服务器端端口

| 端口  | 角色                    | 协议类型 | 内容描述                                      | 数据格式                       |
|-------|-------------------------|----------|-----------------------------------------------|--------------------------------|
| 7000  | 101 监听 (TCP Server)   | 服务端   | 开始检测信号和卷号                            | ASCII 字符 'o' + 卷号字符串    |
| 19800 | 101 监听 (TCP Server)   | 服务端   | 分割定位参数                                  | JSON 格式的参数对象            |

#### 客户端连接

| 端口  | 角色                          | 协议类型 | 内容描述                                      | 数据格式                       |
|-------|-------------------------------|----------|-----------------------------------------------|--------------------------------|
| 19300 | 所有前端机主动连接 (TCP Client) | 客户端   | 特征数据 `'F'` / 状态信息 `'T'`             | ASCII 前缀 + 二进制数据或JSON  |
| 19700 | 101 主动连接 (TCP Client)     | 客户端   | 卷长/宽/速度/卷号/状态（用于服务器界面显示） | JSON 格式的状态对象            |

> 说明：
>
> - `101` 代表主控服务器节点，它既是 TCP 服务端（监听 7000 和 19800 端口），也是 TCP 客户端（连接到 19700 端口）
> - 所有前端机通过 TCP 客户端主动连接到服务器
> - 服务器监听多个端口，分别用于不同类型的指令传输

### Redis 通信协议

在当前部署中，系统使用 Redis 作为分布式通信中间件，用于同步多台机器之间的状态和控制信号。

#### Redis PUB/SUB 通道

| 通道名称           | 发布者      | 订阅者      | 内容描述                       | 数据格式    |
|-------------------|-------------|-------------|--------------------------------|-------------|
| control_signals   | 主控节点    | 所有前端机  | 控制信号（开始/停止检测等）     | JSON 对象   |
| telemetry_data    | 所有前端机  | 主控节点    | 遥测数据（状态、性能指标等）   | JSON 对象   |
| config_updates    | 主控节点    | 所有前端机  | 配置更新                       | JSON 对象   |

#### Redis 键值存储

| 键名                    | 类型      | 用途描述                     | 数据格式    |
|------------------------|-----------|------------------------------|-------------|
| camera_status:*        | Hash      | 相机状态信息                 | Hash 对象   |
| system_config          | String    | 系统配置                     | JSON 字符串 |
| last_detection_result  | String    | 最后检测结果                 | JSON 字符串 |

## 未来架构 - 多相机模式

当系统升级为多相机配置时，所有相机均在同一主机上运行，因此无需依赖 Redis 进行跨主机变量同步。

### 多相机架构通信

在多相机模式下，系统架构将简化为：

1. **本地通信**: 相机之间通过共享内存或队列进行通信
2. **统一控制**: 通过 [MultiCameraCoordinator](file:///d:/codespace/DvpDetect/include/MultiCameraCoordinator.hpp#L1-L33) 统一管理多个相机
3. **集中处理**: 所有图像数据在本地进行处理和融合

## 通信协议实现

### TCP 通信实现

TCP 通信协议由以下组件实现：

- [AsioTcpTransport](file:///d:/codespace/DvpDetect/include/protocol/AsioTcpTransport.hpp#L1-L35): 基于 ASIO 库的 TCP 传输层
- [ProtocolSession](file:///d:/codespace/DvpDetect/include/protocol/ProtocolSession.hpp#L1-L31): 通信会话管理
- [TransportAdapter](file:///d:/codespace/DvpDetect/include/protocol/TransportAdapter.hpp#L1-L17): 传输层适配器

### Redis 通信实现

Redis 通信协议由以下组件实现：

- [IRedisClient](file:///d:/codespace/DvpDetect/include/redis/IRedisClient.hpp#L1-L9): Redis 客户端接口
- [RedisClient](file:///d:/codespace/DvpDetect/include/redis/RedisClient.hpp#L1-L17): Redis 客户端具体实现
- 分布式状态同步模块

## 状态机设计

### 客户端状态机

```
[初始状态] 
    ↓ (连接服务器)
[连接中] 
    ↓ (连接成功)
[已连接] 
    ↓ (开始检测命令)
[检测中] 
    ↓ (检测完成/手动停止)
[已停止] 
    ↓ (断开连接)
[断开中] 
    ↓ (断开完成)
[初始状态]
```

### 服务端状态机

```
[初始状态]
    ↓ (启动服务)
[监听中] (监听端口 7000, 19800)
    ↓ (接收连接)
[连接处理中]
    ↓ (接收检测结果)
[结果处理中]
    ↓ (处理完成)
[监听中]
```

## 错误处理与恢复

### 连接错误处理

1. **连接超时**: 实现重连机制，最多重试 5 次，每次间隔 2 秒
2. **数据传输错误**: 使用校验和验证数据完整性
3. **服务端宕机**: 自动切换到备用服务器（如果配置了）

### Redis 连接错误处理

1. **Redis 连接失败**: 尝试连接备用 Redis 实例
2. **PUB/SUB 消息丢失**: 实现消息确认机制
3. **键值存储异常**: 使用本地缓存作为降级方案

## 性能优化

### TCP 通信优化

1. **连接池**: 复用 TCP 连接，减少连接建立开销
2. **批量传输**: 将多个小数据包合并传输，提高传输效率
3. **压缩算法**: 对大数据包进行压缩传输

### Redis 优化

1. **管道操作**: 批量执行 Redis 命令
2. **过期策略**: 设置合理的键过期时间，避免内存泄漏
3. **持久化配置**: 根据数据重要性选择合适的持久化策略

## 安全考虑

### TCP 安全

1. **IP 白名单**: 限制连接来源 IP
2. **数据加密**: 对敏感数据进行加密传输
3. **认证机制**: 实现连接认证，防止非法接入

### Redis 安全

1. **访问控制**: 设置 Redis 密码认证
2. **网络隔离**: 将 Redis 部署在内网，限制外部访问
3. **权限管理**: 为不同应用分配不同的 Redis 权限

## 监控与日志

### 通信监控

1. **连接状态监控**: 实时监控 TCP 连接状态
2. **消息统计**: 统计发送/接收的消息数量和频率
3. **性能指标**: 监控延迟、吞吐量等性能指标

### 日志记录

1. **通信日志**: 记录所有通信事件和状态变化
2. **错误日志**: 详细记录通信错误和异常情况
3. **性能日志**: 记录通信性能数据，用于分析优化
